<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鏡電視政治組排班表</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* 自定義捲軸樣式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .animate-pulse-custom {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="root"></div>

    <!-- Firebase SDKs (Using ES Modules via script type="module") -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase to window for React to access
        const firebaseConfig = {
            apiKey: "AIzaSyAJ_b9BiX1zT7WFu8f08uoKxeV8vgDUHz4",
            authDomain: "fuktrip.firebaseapp.com",
            projectId: "fuktrip",
            storageBucket: "fuktrip.firebasestorage.app",
            messagingSenderId: "663462561018",
            appId: "1:663462561018:web:d0c9f00c9fed0253a2b543",
            measurementId: "G-KME94X3EKH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.db = db;
        window.auth = auth;
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.setDoc = setDoc;
        window.collection = collection;
    </script>

    <!-- Main Application Logic -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Internal Icon Library (Guaranteed to load) ---
        // 直接內建 SVG Path，解決外部載入不穩定的問題
        const ICONS = {
            Calendar: <path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" />,
            Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>,
            Unlock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 9.9-1" /></>,
            Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2zM12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z" />,
            ChevronLeft: <path d="m15 18-6-6 6-6" />,
            ChevronRight: <path d="m9 18 6-6-6-6" />,
            Trash2: <><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></>,
            Users: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></>,
            ChevronUp: <path d="m18 15-6-6-6 6" />,
            ChevronDown: <path d="m6 9 6 6 6-6" />,
            X: <path d="M18 6 6 18M6 6l12 12" />,
            Plus: <path d="M5 12h14M12 5v14" />,
            GripVertical: <><circle cx="9" cy="12" r="1" /><circle cx="9" cy="5" r="1" /><circle cx="9" cy="19" r="1" /><circle cx="15" cy="12" r="1" /><circle cx="15" cy="5" r="1" /><circle cx="15" cy="19" r="1" /></>,
            CheckCircle: <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14M22 4 12 14.01l-3-3" />,
            Edit2: <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />
        };

        const Icon = ({ name, size = 16, className = "", strokeWidth = 2 }) => {
            const content = ICONS[name];
            if (!content) return null;
            
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth={strokeWidth} 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                >
                    {content}
                </svg>
            );
        };

        // --- Data Constants ---
        const APP_ID = 'mirror-tv-schedule'; 
        const DEFAULT_STAFF_LIST = ['徐葳倫', '李依庭', '吳洛瑩', '尹智剛', '程郁育', '楊旂'];
        
        const SHIFT_TYPES = {
            '': { label: '', color: 'bg-white', text: '' }, 
            '休': { label: '休', color: 'bg-red-100 text-red-700', border: 'border-red-300' },
            '夜': { label: '夜', color: 'bg-slate-800 text-white', border: 'border-slate-600' },
            '特休': { label: '特休', color: 'bg-green-100 text-green-700', border: 'border-green-300' },
            '補': { label: '補', color: 'bg-orange-100 text-orange-700', border: 'border-orange-300' }
        };

        // --- Custom Hook for Debounce ---
        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => {
                    setDebouncedValue(value);
                }, delay);
                return () => clearTimeout(handler);
            }, [value, delay]);
            return debouncedValue;
        }

        const App = () => {
            // --- Basic State ---
            const getInitialDate = () => {
                const today = new Date();
                return new Date(today.getFullYear(), today.getMonth() + 1, 1);
            };
            const [currentDate, setCurrentDate] = useState(getInitialDate);
            const [daysInMonth, setDaysInMonth] = useState([]);

            // --- Data State (Sync with Firebase) ---
            const [staffList, setStaffList] = useState(DEFAULT_STAFF_LIST);
            const [schedule, setSchedule] = useState({});
            const [manpowerReqs, setManpowerReqs] = useState({});
            const [globalLeaveTarget, setGlobalLeaveTarget] = useState(8);
            
            // --- UI State ---
            const [activeCell, setActiveCell] = useState(null); // { person, dateStr, top, left, width, height }
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [editingStaffId, setEditingStaffId] = useState(null);
            const [deletingStaffId, setDeletingStaffId] = useState(null);
            const [tempStaffName, setTempStaffName] = useState('');
            const [newStaffName, setNewStaffName] = useState('');
            const [isLocked, setIsLocked] = useState(false); 
            const [showUnlockModal, setShowUnlockModal] = useState(false);
            const [passwordInput, setPasswordInput] = useState('');
            const [showClearConfirm, setShowClearConfirm] = useState(false); // 新增：清空確認狀態
            const [draggedIndex, setDraggedIndex] = useState(null);
            const [dragOverIndex, setDragOverIndex] = useState(null);
            
            // --- System State ---
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [lastUpdatedByMe, setLastUpdatedByMe] = useState(0); 
            const tableContainerRef = useRef(null);

            // --- Firebase Integration ---
            
            // 1. Auth
            useEffect(() => {
                if (!window.auth) return;
                const initAuth = async () => {
                    try {
                        await window.signInAnonymously(window.auth);
                    } catch (error) {
                        console.error("Auth Error:", error);
                    }
                };
                initAuth();
                const unsubscribe = window.onAuthStateChanged(window.auth, (u) => {
                    setUser(u);
                });
                return () => unsubscribe();
            }, []);

            // 2. Read from Firestore
            useEffect(() => {
                if (!user || !window.db) return;

                const docRef = window.doc(window.db, 'artifacts', APP_ID, 'public', 'data', 'main_data', 'schedule_v1');
                
                const unsubscribe = window.onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (Date.now() - lastUpdatedByMe > 2000) {
                            if (data.staffList) setStaffList(data.staffList);
                            if (data.schedule) setSchedule(data.schedule);
                            if (data.manpowerReqs) setManpowerReqs(data.manpowerReqs);
                            if (data.globalLeaveTarget) setGlobalLeaveTarget(data.globalLeaveTarget);
                        }
                    } else {
                        window.setDoc(docRef, {
                            staffList: DEFAULT_STAFF_LIST,
                            schedule: {},
                            manpowerReqs: {},
                            globalLeaveTarget: 8,
                            updatedAt: Date.now()
                        });
                    }
                    setLoading(false);
                }, (error) => {
                    console.error("Snapshot Error:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user, lastUpdatedByMe]);

            // 3. Write to Firestore
            const dataToSave = {
                staffList,
                schedule,
                manpowerReqs,
                globalLeaveTarget
            };
            
            const debouncedData = useDebounce(dataToSave, 1000); 

            useEffect(() => {
                if (!user || !window.db || loading) return;

                const saveData = async () => {
                    try {
                        const docRef = window.doc(window.db, 'artifacts', APP_ID, 'public', 'data', 'main_data', 'schedule_v1');
                        // 修正：移除 { merge: true } 以便正確覆寫文件，解決清空後資料無法刪除的問題
                        await window.setDoc(docRef, {
                            ...debouncedData,
                            updatedAt: Date.now(),
                            updatedBy: user.uid
                        }); 
                    } catch (error) {
                        console.error("Save Error:", error);
                    }
                };

                saveData();
            }, [debouncedData, user]);

            const markLocalUpdate = () => {
                setLastUpdatedByMe(Date.now());
            };

            // --- Logic Helpers ---
            useEffect(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const date = new Date(year, month, 1);
                const days = [];
                while (date.getMonth() === month) {
                    days.push(new Date(date));
                    date.setDate(date.getDate() + 1);
                }
                setDaysInMonth(days);
            }, [currentDate]);

            const changeMonth = (offset) => {
                setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1));
                setActiveCell(null);
            };

            const getDateKey = (date) => date.toISOString().split('T')[0];
            const getWeekDay = (date) => ['日', '一', '二', '三', '四', '五', '六'][date.getDay()];
            const isWeekend = (date) => date.getDay() === 0 || date.getDay() === 6;

            const getManpowerReq = (date) => {
                const key = getDateKey(date);
                return manpowerReqs[key] !== undefined ? manpowerReqs[key] : (isWeekend(date) ? 3 : 4);
            };

            const updateManpowerReq = (date, value) => {
                if (isLocked) return;
                markLocalUpdate();
                setManpowerReqs(prev => ({ ...prev, [getDateKey(date)]: parseInt(value) || 0 }));
            };

            const calculateActualManpower = (date) => {
                const dateStr = getDateKey(date);
                let workingCount = 0;
                staffList.forEach(person => {
                    const shift = schedule[`${person}-${dateStr}`];
                    const isOff = ['休', '特休', '補'].includes(shift);
                    if (!isOff) workingCount++;
                });
                return workingCount;
            };

            const calculateUsedLeave = (person) => {
                let count = 0;
                daysInMonth.forEach(day => {
                    const shift = schedule[`${person}-${getDateKey(day)}`];
                    if (['休', '特休', '補'].includes(shift)) {
                        count++;
                    }
                });
                return count;
            };

            // --- Event Handlers ---
            const handleCellClick = (person, dateStr, e) => {
                e.stopPropagation();
                e.preventDefault();
                if (isLocked) return;

                if (activeCell && activeCell.person === person && activeCell.dateStr === dateStr) {
                    setActiveCell(null);
                    return;
                }
                const rect = e.currentTarget.getBoundingClientRect();
                setActiveCell({
                    person,
                    dateStr,
                    top: rect.bottom, 
                    left: rect.left,
                    height: rect.height,
                    width: rect.width
                });
            };

            const setShift = (type) => {
                if (!activeCell) return;
                const key = `${activeCell.person}-${activeCell.dateStr}`;
                markLocalUpdate();
                setSchedule(prev => {
                    const newSchedule = { ...prev };
                    type === '' ? delete newSchedule[key] : newSchedule[key] = type;
                    return newSchedule;
                });
                setActiveCell(null);
            };

            const clearCurrentMonthData = () => {
                if (isLocked) return;
                
                markLocalUpdate();
                const newSchedule = { ...schedule };
                daysInMonth.forEach(day => {
                    staffList.forEach(person => delete newSchedule[`${person}-${getDateKey(day)}`]);
                });
                setSchedule(newSchedule);
                setShowClearConfirm(false); // 重置確認狀態
            };

            const handleClearClick = () => {
                if (isLocked) return;
                if (showClearConfirm) {
                    clearCurrentMonthData();
                } else {
                    setShowClearConfirm(true);
                    // 3秒後自動取消確認狀態
                    setTimeout(() => setShowClearConfirm(false), 3000);
                }
            };

            const handleLockToggle = () => {
                if (isLocked) {
                    setShowUnlockModal(true);
                } else {
                    setIsLocked(true);
                }
            };

            const handleUnlockSubmit = (e) => {
                e.preventDefault();
                if (passwordInput === '123') {
                    setIsLocked(false);
                    setShowUnlockModal(false);
                    setPasswordInput('');
                } else {
                    alert('密碼錯誤');
                    setPasswordInput('');
                }
            };

            // --- Staff Management ---
            const handleAddStaff = () => {
                const name = newStaffName.trim();
                if (name && !staffList.includes(name)) {
                    markLocalUpdate();
                    setStaffList([...staffList, name]);
                    setNewStaffName('');
                } else if (staffList.includes(name)) {
                    alert("人員已存在");
                }
            };

            const initiateDelete = (name) => setDeletingStaffId(name);
            
            const confirmDelete = (name) => {
                markLocalUpdate();
                setStaffList(staffList.filter(s => s !== name));
                setDeletingStaffId(null);
            };

            const startEditStaff = (name) => {
                setEditingStaffId(name);
                setTempStaffName(name);
                setDeletingStaffId(null);
            };

            const saveEditStaff = (oldName) => {
                if (!tempStaffName.trim()) return;
                if (staffList.includes(tempStaffName) && tempStaffName !== oldName) {
                    alert("名稱重複");
                    return;
                }
                markLocalUpdate();
                const newList = staffList.map(s => s === oldName ? tempStaffName : s);
                setStaffList(newList);

                const newSchedule = { ...schedule };
                Object.keys(newSchedule).forEach(key => {
                    const [pName, ...rest] = key.split('-');
                    const datePart = rest.join('-');
                    if (pName === oldName) {
                        newSchedule[`${tempStaffName}-${datePart}`] = newSchedule[key];
                        delete newSchedule[key];
                    }
                });
                setSchedule(newSchedule);
                setEditingStaffId(null);
            };

            // --- Drag & Drop ---
            const handleDragStart = (e, index) => {
                setDraggedIndex(index);
                e.dataTransfer.effectAllowed = "move";
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
                if (draggedIndex === index) return;
                setDragOverIndex(index);
            };

            const handleDrop = (e, index) => {
                e.preventDefault();
                if (draggedIndex === null || draggedIndex === index) return;

                markLocalUpdate();
                const newStaffList = [...staffList];
                const draggedItemContent = newStaffList[draggedIndex];
                
                newStaffList.splice(draggedIndex, 1);
                newStaffList.splice(index, 0, draggedItemContent);
                
                setStaffList(newStaffList);
                setDraggedIndex(null);
                setDragOverIndex(null);
            };

            const handleDragEnd = () => {
                setDraggedIndex(null);
                setDragOverIndex(null);
            };

            // --- Global Click Listener ---
            useEffect(() => {
                const handleClickOutside = () => setActiveCell(null);
                window.addEventListener('click', handleClickOutside);
                const tableEl = tableContainerRef.current;
                if (tableEl) tableEl.addEventListener('scroll', handleClickOutside);
                return () => {
                    window.removeEventListener('click', handleClickOutside);
                    if (tableEl) tableEl.removeEventListener('scroll', handleClickOutside);
                };
            }, []);

            if (loading) {
                return (
                    <div className="flex h-screen w-full items-center justify-center bg-gray-50 flex-col gap-4">
                        <div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <p className="text-gray-500 font-medium animate-pulse">正在同步雲端資料庫...</p>
                    </div>
                );
            }
            
            // --- Popover Positioning Logic ---
            let popoverStyle = {};
            if (activeCell) {
                const MENU_HEIGHT = 280; // 預估選單高度
                const spaceBelow = window.innerHeight - activeCell.top;
                const showAbove = spaceBelow < MENU_HEIGHT; // 如果下方空間不足，則顯示在上方

                popoverStyle = {
                    left: Math.min(activeCell.left, window.innerWidth - 100), // 防止超出右邊
                    top: showAbove 
                         ? activeCell.top - activeCell.height - 10 // 顯示在格子上方，微調間距
                         : activeCell.top + 5, // 顯示在格子下方
                };
                
                // 如果是顯示在上方，還需要把選單往上推 (transform translate)
                if (showAbove) {
                    popoverStyle.transform = 'translateY(-100%)';
                }
            }

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-800 flex flex-col">
                    {/* Header */}
                    <header className="bg-white shadow-sm sticky top-0 z-30">
                        <div className="px-4 py-3 mx-auto flex flex-col lg:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-lg shadow-lg">
                                    <Icon name="Calendar" className="text-white" size={24} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-gray-900 leading-tight">鏡電視政治組排班表</h1>
                                    <div className="flex items-center gap-1 text-xs text-green-600">
                                        <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                        雲端同步中
                                    </div>
                                </div>
                                
                                <button 
                                    onClick={handleLockToggle}
                                    className={`ml-2 flex items-center gap-1 px-3 py-1.5 rounded-full text-sm font-medium transition-all ${
                                        isLocked 
                                        ? 'bg-red-50 text-red-600 border border-red-200 hover:bg-red-100' 
                                        : 'bg-green-50 text-green-700 border border-green-200 hover:bg-green-100'
                                    }`}
                                >
                                    <Icon name={isLocked ? "Lock" : "Unlock"} size={14} />
                                    {isLocked ? "已鎖定" : "編輯中"}
                                </button>

                                <button 
                                    onClick={() => isLocked ? setShowUnlockModal(true) : setIsSettingsOpen(true)}
                                    className={`p-1.5 rounded-full transition-all border ${isLocked ? 'text-gray-300 border-transparent cursor-not-allowed' : 'text-gray-400 hover:text-blue-600 hover:bg-blue-50 border-transparent hover:border-blue-100'}`}
                                    title="設定人員"
                                >
                                    <Icon name="Settings" size={18} />
                                </button>
                            </div>

                            <div className="flex items-center bg-gray-100 rounded-lg p-1 shadow-inner">
                                <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-white rounded-md shadow-sm text-gray-600">
                                    <Icon name="ChevronLeft" size={20} />
                                </button>
                                <span className="px-4 py-1 font-mono text-lg font-semibold min-w-[140px] text-center">
                                    {currentDate.getFullYear()} 年 {currentDate.getMonth() + 1} 月
                                </span>
                                <button onClick={() => changeMonth(1)} className="p-2 hover:bg-white rounded-md shadow-sm text-gray-600">
                                    <Icon name="ChevronRight" size={20} />
                                </button>
                            </div>

                            <div className="flex flex-wrap items-center gap-2 justify-center lg:justify-end">
                                <div className={`flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg border border-gray-200 ${isLocked ? 'opacity-60 grayscale' : ''}`}>
                                    <span className="text-sm text-gray-600 font-medium">本月應休:</span>
                                    <input 
                                        type="number" 
                                        min="0"
                                        max="15"
                                        disabled={isLocked}
                                        value={globalLeaveTarget}
                                        onChange={(e) => {
                                            markLocalUpdate();
                                            setGlobalLeaveTarget(e.target.value);
                                        }}
                                        className="w-12 text-center text-sm font-bold bg-white border border-gray-300 rounded focus:border-blue-500 focus:outline-none disabled:bg-gray-100"
                                    />
                                    <span className="text-sm text-gray-600">天</span>
                                </div>

                                <button 
                                    onClick={handleClearClick} 
                                    disabled={isLocked}
                                    className={`flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg border transition-colors ${
                                        isLocked 
                                        ? 'text-gray-400 bg-gray-100 border-gray-200 cursor-not-allowed' 
                                        : showClearConfirm 
                                            ? 'bg-red-600 text-white border-red-700 hover:bg-red-700 shadow-md animate-pulse'
                                            : 'text-red-600 bg-red-50 hover:bg-red-100 border-red-200'
                                    }`}
                                >
                                    <Icon name={showClearConfirm ? "X" : "Trash2"} size={16} /> 
                                    <span className="hidden sm:inline">
                                        {showClearConfirm ? "確認清空?" : "清空"}
                                    </span>
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Table */}
                    <main className="flex-1 overflow-hidden p-2 md:p-4 flex flex-col">
                        <div ref={tableContainerRef} className="flex-1 overflow-auto bg-white rounded-xl shadow border border-gray-200 relative">
                            <table className="w-full border-collapse">
                                <thead className="sticky top-0 z-20 bg-gray-50 text-xs md:text-sm shadow-sm">
                                    <tr>
                                        <th className="sticky left-0 z-20 bg-gray-100 p-2 border-b border-r border-gray-200 min-w-[140px] text-left font-bold text-gray-600 h-14 align-bottom">
                                            人員
                                        </th>
                                        {daysInMonth.map(date => {
                                            const isWeek = isWeekend(date);
                                            return (
                                                <th key={getDateKey(date)} className={`p-1 min-w-[48px] text-center border-b border-gray-200 ${isWeek ? 'bg-red-50 text-red-600' : ''}`}>
                                                    <div className="font-bold text-lg leading-none">{date.getDate()}</div>
                                                    <div className="text-[10px] opacity-75 mt-1">{getWeekDay(date)}</div>
                                                </th>
                                            );
                                        })}
                                    </tr>
                                    
                                    <tr className="bg-blue-50/50">
                                        <th className="sticky left-0 z-20 bg-blue-50 p-2 border-b border-r border-gray-200 text-left text-xs font-semibold text-blue-700">
                                            <div className="flex items-center gap-2">
                                                <Icon name="Users" size={14} />
                                                目標上班人數
                                            </div>
                                        </th>
                                        {daysInMonth.map(date => {
                                            const req = getManpowerReq(date);
                                            const actual = calculateActualManpower(date);
                                            const isShort = actual < req;
                                            return (
                                                <td key={getDateKey(date)} className="p-1 border-b border-gray-200 text-center relative align-middle">
                                                    <div className={`flex flex-col items-center justify-center gap-0.5 ${isLocked ? 'opacity-60' : ''}`}>
                                                        <button 
                                                            onClick={() => updateManpowerReq(date, req + 1)}
                                                            disabled={isLocked}
                                                            className={`p-0.5 rounded hover:bg-blue-100 text-blue-600 transition-colors ${isLocked ? 'cursor-not-allowed text-gray-400 hover:bg-transparent' : ''}`}
                                                        >
                                                            <Icon name="ChevronUp" size={12} strokeWidth={3} />
                                                        </button>
                                                        
                                                        <div className="font-bold text-blue-700 leading-none select-none">
                                                            {req}
                                                        </div>

                                                        <button 
                                                            onClick={() => updateManpowerReq(date, Math.max(0, req - 1))}
                                                            disabled={isLocked}
                                                            className={`p-0.5 rounded hover:bg-blue-100 text-blue-600 transition-colors ${isLocked ? 'cursor-not-allowed text-gray-400 hover:bg-transparent' : ''}`}
                                                        >
                                                            <Icon name="ChevronDown" size={12} strokeWidth={3} />
                                                        </button>
                                                    </div>
                                                    
                                                    {isShort && <div className="absolute top-1 right-1 w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></div>}
                                                </td>
                                            );
                                        })}
                                    </tr>
                                </thead>

                                <tbody className="text-sm">
                                    {staffList.map((person) => {
                                        const usedLeave = calculateUsedLeave(person);
                                        const isReached = usedLeave >= globalLeaveTarget;
                                        const isOver = usedLeave > globalLeaveTarget;

                                        return (
                                            <tr key={person} className="hover:bg-gray-50 transition-colors group">
                                                <td className="sticky left-0 z-10 bg-white p-0 border-b border-r border-gray-200 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                                                    <div className="flex h-12 items-center px-3 justify-between">
                                                        <span className="font-medium text-gray-800">{person}</span>
                                                        <span className={`text-[10px] px-1.5 py-0.5 rounded-full ${isOver ? 'bg-red-100 text-red-600 font-bold' : isReached ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>
                                                            已休 {usedLeave}
                                                        </span>
                                                    </div>
                                                </td>

                                                {daysInMonth.map(date => {
                                                    const dateStr = getDateKey(date);
                                                    const key = `${person}-${dateStr}`;
                                                    const shiftType = schedule[key] || '';
                                                    const shiftStyle = SHIFT_TYPES[shiftType] || SHIFT_TYPES[''];

                                                    return (
                                                        <td 
                                                            key={dateStr} 
                                                            className={`p-1 border-b border-r border-gray-100 text-center select-none ${isLocked ? 'cursor-default' : 'cursor-pointer'}`}
                                                            onClick={(e) => handleCellClick(person, dateStr, e)}
                                                        >
                                                            <div className={`
                                                                w-full h-10 flex items-center justify-center rounded font-bold text-sm transition-all
                                                                ${shiftType ? `${shiftStyle.color} ${shiftStyle.border} border shadow-sm` : (isLocked ? '' : 'hover:bg-gray-100')}
                                                            `}>
                                                                {shiftType}
                                                            </div>
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        );
                                    })}
                                    
                                    <tr className="bg-slate-50 border-t-2 border-slate-200">
                                        <td className="sticky left-0 z-10 bg-slate-100 p-3 border-r border-gray-300 font-bold text-slate-700 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] text-right pr-4">
                                            實際上班人數
                                        </td>
                                        {daysInMonth.map(date => {
                                            const actual = calculateActualManpower(date);
                                            const req = getManpowerReq(date);
                                            const isShort = actual < req;
                                            return (
                                                <td key={`total-${getDateKey(date)}`} className={`p-1 border-r border-slate-200 text-center font-mono font-bold text-sm ${isShort ? 'bg-red-50 text-red-600' : 'text-slate-600'}`}>
                                                    {actual}
                                                </td>
                                            )
                                        })}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </main>

                    {/* Floating Menu Portal - Improved Positioning */}
                    {activeCell && (
                        <div 
                            className="fixed z-[9999] bg-white rounded-lg shadow-xl border border-gray-200 p-1 flex flex-col gap-1 w-24 animate-in fade-in zoom-in duration-150"
                            style={popoverStyle}
                            onClick={(e) => e.stopPropagation()} 
                        >
                            <div className="text-xs text-gray-400 px-2 py-1 text-center border-b border-gray-100 mb-1">
                                {activeCell.person}
                            </div>
                            <button 
                                onClick={() => setShift('')} 
                                className="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded text-left transition-colors"
                            >
                                清除 (上班)
                            </button>
                            {Object.keys(SHIFT_TYPES).filter(t => t !== '').map(type => (
                                <button
                                    key={type}
                                    onClick={() => setShift(type)}
                                    className={`px-3 py-2 text-sm font-bold rounded text-center border active:scale-95 ${SHIFT_TYPES[type].color} ${SHIFT_TYPES[type].border}`}
                                >
                                    {type}
                                </button>
                            ))}
                        </div>
                    )}

                    {/* Staff Settings Modal */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center backdrop-blur-sm p-4" onClick={() => setIsSettingsOpen(false)}>
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                    <h2 className="text-lg font-bold flex items-center gap-2">
                                        <Icon name="Settings" size={20} className="text-gray-600" />
                                        人員管理
                                    </h2>
                                    <button onClick={() => setIsSettingsOpen(false)} className="p-2 hover:bg-gray-200 rounded-full transition-colors">
                                        <Icon name="X" size={20} />
                                    </button>
                                </div>

                                <div className="p-6 overflow-y-auto">
                                    <div className="flex gap-2 mb-6">
                                        <input 
                                            type="text" 
                                            placeholder="輸入姓名..."
                                            value={newStaffName}
                                            onChange={(e) => setNewStaffName(e.target.value)}
                                            onKeyDown={(e) => e.key === 'Enter' && handleAddStaff()}
                                            className="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                        />
                                        <button 
                                            onClick={handleAddStaff}
                                            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-medium flex items-center gap-1 transition-colors disabled:opacity-50"
                                            disabled={!newStaffName.trim()}
                                        >
                                            <Icon name="Plus" size={16} /> 新增
                                        </button>
                                    </div>

                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-sm text-gray-500 font-medium">現有人員 (可拖曳排序)</span>
                                    </div>

                                    <div className="flex flex-col gap-2">
                                        {staffList.map((person, index) => (
                                            <div 
                                                key={person} 
                                                draggable
                                                onDragStart={(e) => handleDragStart(e, index)}
                                                onDragOver={(e) => handleDragOver(e, index)}
                                                onDrop={(e) => handleDrop(e, index)}
                                                onDragEnd={handleDragEnd}
                                                className={`flex items-center gap-3 p-3 bg-white border rounded-lg shadow-sm transition-all group select-none 
                                                    ${draggedIndex === index ? 'opacity-50 bg-gray-100 border-dashed border-gray-400' : 'border-gray-200 hover:shadow-md'}
                                                    ${dragOverIndex === index ? 'border-blue-500 ring-2 ring-blue-100 scale-[1.02]' : ''}
                                                `}
                                            >
                                                <div className="cursor-grab active:cursor-grabbing p-1 text-gray-300 hover:text-gray-500">
                                                    <Icon name="GripVertical" size={20} />
                                                </div>
                                                
                                                {editingStaffId === person ? (
                                                    <div className="flex-1 flex gap-2 animate-in fade-in">
                                                        <input 
                                                            autoFocus
                                                            value={tempStaffName}
                                                            onChange={(e) => setTempStaffName(e.target.value)}
                                                            className="flex-1 border rounded px-2 py-1 text-sm outline-blue-500"
                                                        />
                                                        <button onClick={() => saveEditStaff(person)} className="p-1 bg-green-100 text-green-600 rounded hover:bg-green-200">
                                                            <Icon name="CheckCircle" size={16} />
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <span className="flex-1 font-medium text-gray-700">{person}</span>
                                                )}

                                                <div className="flex gap-1">
                                                    {editingStaffId !== person && (
                                                        <>
                                                            {deletingStaffId === person ? (
                                                                <div className="flex items-center gap-1 animate-in slide-in-from-right duration-200">
                                                                    <button 
                                                                        onClick={() => confirmDelete(person)}
                                                                        className="px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 font-bold"
                                                                    >
                                                                        確認刪除
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => setDeletingStaffId(null)}
                                                                        className="p-1 text-gray-400 hover:text-gray-600 rounded"
                                                                    >
                                                                        <Icon name="X" size={16} />
                                                                    </button>
                                                                </div>
                                                            ) : (
                                                                <>
                                                                    <button 
                                                                        onClick={() => startEditStaff(person)}
                                                                        className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors"
                                                                    >
                                                                        <Icon name="Edit2" size={16} />
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => initiateDelete(person)}
                                                                        className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
                                                                    >
                                                                        <Icon name="Trash2" size={16} />
                                                                    </button>
                                                                </>
                                                            )}
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Unlock Modal */}
                    {showUnlockModal && (
                        <div className="fixed inset-0 z-[60] bg-black/60 flex items-center justify-center backdrop-blur-sm p-4">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
                                <div className="p-6 flex flex-col items-center gap-4">
                                    <div className="bg-blue-50 p-4 rounded-full">
                                        <Icon name="Lock" size={32} className="text-blue-500" />
                                    </div>
                                    <h3 className="text-lg font-bold text-gray-800">班表已鎖定</h3>
                                    <p className="text-sm text-gray-500 text-center">請輸入密碼以解鎖編輯權限</p>
                                    
                                    <form onSubmit={handleUnlockSubmit} className="w-full flex gap-2 mt-2">
                                        <input 
                                            type="password" 
                                            autoFocus
                                            placeholder="密碼"
                                            value={passwordInput}
                                            onChange={(e) => setPasswordInput(e.target.value)}
                                            className="flex-1 border border-gray-300 rounded-lg px-4 py-2 text-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                        />
                                        <button 
                                            type="submit"
                                            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-medium"
                                        >
                                            解鎖
                                        </button>
                                    </form>
                                    
                                    <button 
                                        onClick={() => { setShowUnlockModal(false); setPasswordInput(''); }}
                                        className="text-gray-400 text-xs hover:text-gray-600 underline"
                                    >
                                        取消
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
