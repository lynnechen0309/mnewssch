<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鏡電視政治組排班表</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- html2canvas for Screenshot -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* 自定義捲軸樣式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .animate-pulse-custom {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="root"></div>

    <!-- Firebase SDKs (Using ES Modules via script type="module") -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase to window for React to access
        const firebaseConfig = {
            apiKey: "AIzaSyBvpQpgQoNiiTvR3zBdgAkDAQCkqud33fA",
            authDomain: "mnewsch.firebaseapp.com",
            projectId: "mnewsch",
            storageBucket: "mnewsch.firebasestorage.app",
            messagingSenderId: "726148839052",
            appId: "1:726148839052:web:1b16d6d17d4cecbe0fada9",
            measurementId: "G-CLFN0LM0X5"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            window.db = db;
            window.auth = auth;
            window.signInAnonymously = signInAnonymously;
            window.onAuthStateChanged = onAuthStateChanged;
            window.doc = doc;
            window.onSnapshot = onSnapshot;
            window.setDoc = setDoc;
            window.collection = collection;
        } catch (e) {
            console.error("Firebase Init Error:", e);
            // Fallback for initialization errors
            window.firebaseInitError = true;
        }
    </script>

    <!-- Main Application Logic -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Internal Icon Library ---
        const ICONS = {
            Calendar: <path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" />,
            Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>,
            Unlock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 9.9-1" /></>,
            Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2zM12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z" />,
            ChevronLeft: <path d="m15 18-6-6 6-6" />,
            ChevronRight: <path d="m9 18 6-6-6-6" />,
            Trash2: <><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></>,
            Users: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></>,
            ChevronUp: <path d="m18 15-6-6-6 6" />,
            ChevronDown: <path d="m6 9 6 6 6-6" />,
            X: <path d="M18 6 6 18M6 6l12 12" />,
            Plus: <path d="M5 12h14M12 5v14" />,
            GripVertical: <><circle cx="9" cy="12" r="1" /><circle cx="9" cy="5" r="1" /><circle cx="9" cy="19" r="1" /><circle cx="15" cy="12" r="1" /><circle cx="15" cy="5" r="1" /><circle cx="15" cy="19" r="1" /></>,
            CheckCircle: <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14M22 4 12 14.01l-3-3" />,
            Edit2: <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />,
            History: <><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /><path d="M12 7v5l4 2" /></>,
            Key: <><path d="m21 2-2 2m-7.6 7.6a6 6 0 1 1-1.4-1.4L11 11l5 5a2 2 0 0 1 2.8 2.8l.9.9m-1.5-1.5-.9-.9" /><circle cx="7.5" cy="7.5" r=".5" fill="currentColor" /></>,
            Download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />,
            CloudCheck: <path d="m9 11 3 3L22 4" />,
            CloudUpload: <><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" /><path d="M12 12v9" /><path d="m16 16-4-4-4 4" /></>,
            CloudOff: <path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 7h1.8M5 19.5A9 9 0 0 1 5 19.5M2 2l20 20" />
        };

        const Icon = ({ name, size = 16, className = "", strokeWidth = 2 }) => {
            const content = ICONS[name];
            if (!content) return null;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {content}
                </svg>
            );
        };

        // --- Data Constants ---
        const APP_ID = 'mirror-tv-schedule'; 
        const DEFAULT_STAFF_LIST = ['徐葳倫', '李依庭', '吳洛瑩', '尹智剛', '程郁育', '楊旂'];
        
        const SHIFT_TYPES = {
            '': { label: '', color: 'bg-white', text: '' }, 
            '休': { label: '休', color: 'bg-red-100 text-red-700', border: 'border-red-300' },
            '夜': { label: '夜', color: 'bg-slate-800 text-white', border: 'border-slate-600' },
            '特休': { label: '特休', color: 'bg-green-100 text-green-700', border: 'border-green-300' },
            '補': { label: '補', color: 'bg-orange-100 text-orange-700', border: 'border-orange-300' }
        };

        // --- Custom Hook for Debounce ---
        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => setDebouncedValue(value), delay);
                return () => clearTimeout(handler);
            }, [value, delay]);
            return debouncedValue;
        }

        const App = () => {
            // --- Basic State ---
            const getInitialDate = () => {
                const today = new Date();
                return new Date(today.getFullYear(), today.getMonth() + 1, 1);
            };
            const [currentDate, setCurrentDate] = useState(getInitialDate);
            const [daysInMonth, setDaysInMonth] = useState([]);

            // --- Data State (Sync with Firebase) ---
            const [staffList, setStaffList] = useState(DEFAULT_STAFF_LIST);
            const [schedule, setSchedule] = useState({});
            const [manpowerReqs, setManpowerReqs] = useState({});
            const [globalLeaveTarget, setGlobalLeaveTarget] = useState(8);
            const [memberSettings, setMemberSettings] = useState({}); 
            const [editLogs, setEditLogs] = useState([]); 
            
            // --- UI State ---
            const [activeCell, setActiveCell] = useState(null); 
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isHistoryOpen, setIsHistoryOpen] = useState(false); 
            const [editingStaffId, setEditingStaffId] = useState(null);
            const [deletingStaffId, setDeletingStaffId] = useState(null);
            const [tempStaffName, setTempStaffName] = useState('');
            const [newStaffName, setNewStaffName] = useState('');
            const [isLocked, setIsLocked] = useState(false); 
            const [screenshotLoading, setScreenshotLoading] = useState(false);
            const [saveStatus, setSaveStatus] = useState('saved'); // saved, saving
            const [isOfflineMode, setIsOfflineMode] = useState(false); // New Offline Mode Flag
            
            // 通用密碼 Modal 狀態
            const [modalConfig, setModalConfig] = useState({ isOpen: false, type: '', title: '', message: '', target: null });
            const [passwordInput, setPasswordInput] = useState('');
            
            const [draggedIndex, setDraggedIndex] = useState(null);
            const [dragOverIndex, setDragOverIndex] = useState(null);
            
            // --- System State ---
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [lastUpdatedAt, setLastUpdatedAt] = useState(null);
            const lastUpdatedByMeRef = useRef(0);
            const tableContainerRef = useRef(null);
            const tableRef = useRef(null);

            // --- Firebase Integration ---
            
            useEffect(() => {
                if (!window.auth || window.firebaseInitError) {
                    setIsOfflineMode(true);
                    setUser({ uid: 'offline_user' });
                    setLoading(false);
                    return;
                }

                const initAuth = async () => {
                    try { 
                        await window.signInAnonymously(window.auth); 
                    } catch (e) { 
                        console.warn("Auth Failed, switching to Offline Mode:", e);
                        setIsOfflineMode(true);
                        setUser({ uid: 'offline_user' });
                        setLoading(false);
                    }
                };
                initAuth();
                
                const unsubscribe = window.onAuthStateChanged(window.auth, (u) => {
                    if(u) {
                        setUser(u);
                        setIsOfflineMode(false);
                    }
                });
                return () => unsubscribe && unsubscribe();
            }, []);

            // 修正後的 onSnapshot / LocalStorage Load 邏輯
            useEffect(() => {
                // 如果是離線模式，讀取 LocalStorage
                if (isOfflineMode) {
                    try {
                        const savedData = localStorage.getItem('mirror_schedule_local_backup');
                        if (savedData) {
                            const data = JSON.parse(savedData);
                            if (data.staffList) setStaffList(data.staffList);
                            if (data.scheduleJson) setSchedule(JSON.parse(data.scheduleJson));
                            if (data.manpowerReqsJson) setManpowerReqs(JSON.parse(data.manpowerReqsJson));
                            if (data.globalLeaveTarget) setGlobalLeaveTarget(data.globalLeaveTarget);
                            if (data.memberSettings) setMemberSettings(data.memberSettings);
                            if (data.editLogs) setEditLogs(data.editLogs);
                            if (data.updatedAt) setLastUpdatedAt(data.updatedAt);
                        }
                    } catch (e) {
                        console.error("Local Load Error:", e);
                    }
                    setLoading(false);
                    return;
                }

                if (!user || !window.db) return;
                const docRef = window.doc(window.db, 'artifacts', APP_ID, 'public', 'data', 'main_data', 'schedule_v1');
                
                const unsubscribe = window.onSnapshot(docRef, { includeMetadataChanges: true }, (docSnap) => {
                    if (docSnap.exists()) {
                        if (docSnap.metadata.hasPendingWrites) return;

                        const data = docSnap.data();
                        
                        if (Date.now() - lastUpdatedByMeRef.current > 2000) {
                            if (data.staffList) setStaffList(data.staffList);
                            try {
                                if (data.scheduleJson) setSchedule(JSON.parse(data.scheduleJson));
                                else if (data.schedule) setSchedule(data.schedule);
                            } catch (e) { console.warn("Schedule parse error", e); }

                            try {
                                if (data.manpowerReqsJson) setManpowerReqs(JSON.parse(data.manpowerReqsJson));
                                else if (data.manpowerReqs) setManpowerReqs(data.manpowerReqs);
                            } catch (e) { console.warn("ManpowerReqs parse error", e); }

                            if (data.globalLeaveTarget) setGlobalLeaveTarget(data.globalLeaveTarget);
                            if (data.memberSettings) setMemberSettings(data.memberSettings);
                            if (data.editLogs) setEditLogs(data.editLogs);
                            if (data.updatedAt) setLastUpdatedAt(data.updatedAt);
                        }
                    } else {
                        // Init doc
                        window.setDoc(docRef, {
                            staffList: DEFAULT_STAFF_LIST,
                            scheduleJson: JSON.stringify({}),
                            manpowerReqsJson: JSON.stringify({}),
                            globalLeaveTarget: 8,
                            memberSettings: {},
                            editLogs: [],
                            updatedAt: Date.now()
                        });
                    }
                    setLoading(false);
                }, (error) => {
                    console.warn("Snapshot Error, switching to Offline:", error);
                    setIsOfflineMode(true);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user, isOfflineMode]);

            // --- Write to Firebase / LocalStorage & Logging ---
            const dataToSave = { 
                staffList, 
                scheduleJson: JSON.stringify(schedule), // Serialize
                manpowerReqsJson: JSON.stringify(manpowerReqs), // Serialize
                globalLeaveTarget, 
                memberSettings, 
                editLogs 
            };
            
            const debouncedData = useDebounce(dataToSave, 1000); 

            useEffect(() => {
                if (loading) return;
                
                if (Date.now() - lastUpdatedByMeRef.current < 2000) {
                    setSaveStatus('saving');
                }

                const saveData = async () => {
                    const timestamp = Date.now();
                    
                    // 離線模式：存到 LocalStorage
                    if (isOfflineMode) {
                        try {
                            localStorage.setItem('mirror_schedule_local_backup', JSON.stringify({
                                ...debouncedData,
                                updatedAt: timestamp
                            }));
                            setLastUpdatedAt(timestamp);
                            setSaveStatus('saved');
                        } catch (e) {
                            console.error("Local Save Error:", e);
                            setSaveStatus('error');
                        }
                        return;
                    }

                    // 線上模式：存到 Firebase
                    if (!user || !window.db) return;
                    try {
                        const docRef = window.doc(window.db, 'artifacts', APP_ID, 'public', 'data', 'main_data', 'schedule_v1');
                        await window.setDoc(docRef, { 
                            ...debouncedData, 
                            updatedAt: timestamp, 
                            updatedBy: user.uid 
                        }, { merge: true });
                        
                        setLastUpdatedAt(timestamp);
                        setSaveStatus('saved');
                    } catch (error) { 
                        console.error("Save Error:", error);
                        // 如果存檔失敗，自動降級為離線模式並嘗試存檔
                        setIsOfflineMode(true);
                    }
                };
                saveData();
            }, [debouncedData, user, isOfflineMode]);

            const markLocalUpdate = () => { 
                lastUpdatedByMeRef.current = Date.now(); 
                setSaveStatus('saving');
            };

            const addLog = (message) => {
                const newLog = { timestamp: Date.now(), message, user: 'User' };
                setEditLogs(prevLogs => [newLog, ...prevLogs].slice(0, 50)); 
            };

            // --- Logic Helpers ---
            useEffect(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const date = new Date(year, month, 1);
                const days = [];
                while (date.getMonth() === month) {
                    days.push(new Date(date));
                    date.setDate(date.getDate() + 1);
                }
                setDaysInMonth(days);
            }, [currentDate]);

            const changeMonth = (offset) => {
                setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1));
                setActiveCell(null);
            };

            const getDateKey = (date) => date.toISOString().split('T')[0];
            const getWeekDay = (date) => ['日', '一', '二', '三', '四', '五', '六'][date.getDay()];
            const isWeekend = (date) => date.getDay() === 0 || date.getDay() === 6;

            const getManpowerReq = (date) => {
                const key = getDateKey(date);
                return manpowerReqs[key] !== undefined ? manpowerReqs[key] : (isWeekend(date) ? 3 : 4);
            };

            const updateManpowerReq = (date, value) => {
                if (isLocked) return;
                markLocalUpdate();
                setManpowerReqs(prev => ({ ...prev, [getDateKey(date)]: parseInt(value) || 0 }));
                addLog(`調整 ${getDateKey(date)} 應上班人數為 ${value}`);
            };

            const calculateActualManpower = (date) => {
                const dateStr = getDateKey(date);
                let workingCount = 0;
                staffList.forEach(person => {
                    const shift = schedule[`${person}-${dateStr}`];
                    const isOff = ['休', '特休', '補'].includes(shift);
                    if (!isOff) workingCount++;
                });
                return workingCount;
            };

            const calculateUsedLeave = (person) => {
                let count = 0;
                daysInMonth.forEach(day => {
                    const shift = schedule[`${person}-${getDateKey(day)}`];
                    if (['休', '特休', '補'].includes(shift)) {
                        count++;
                    }
                });
                return count;
            };

            // --- Image Save Handler ---
            const handleDownloadImage = async () => {
                if (!tableRef.current) return;
                setScreenshotLoading(true);
                try {
                    const originalOverflow = tableContainerRef.current.style.overflow;
                    tableContainerRef.current.style.overflow = 'visible';
                    
                    const canvas = await html2canvas(tableRef.current, {
                        scale: 2, 
                        useCORS: true,
                        backgroundColor: '#ffffff'
                    });
                    
                    tableContainerRef.current.style.overflow = originalOverflow;

                    const link = document.createElement('a');
                    link.download = `鏡電視班表_${currentDate.getFullYear()}_${currentDate.getMonth() + 1}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (err) {
                    console.error("Screenshot failed:", err);
                    alert("存檔失敗，請稍後再試");
                } finally {
                    setScreenshotLoading(false);
                }
            };

            // --- Modal Handlers ---
            const openModal = (type, title, message, target = null) => {
                setModalConfig({ isOpen: true, type, title, message, target });
                setPasswordInput('');
            };

            const closeModal = () => {
                setModalConfig({ ...modalConfig, isOpen: false });
                setPasswordInput('');
            };

            const handleModalConfirm = (e) => {
                e.preventDefault();
                const { type, target } = modalConfig;

                if (type === 'GLOBAL_UNLOCK') {
                    if (passwordInput === '123') {
                        setIsLocked(false);
                        closeModal();
                    } else {
                        alert('密碼錯誤');
                    }
                } else if (type === 'SETTINGS_ACCESS') {
                    if (passwordInput === '123456') {
                        closeModal();
                        setIsSettingsOpen(true);
                    } else {
                        alert('密碼錯誤');
                    }
                } else if (type === 'CLEAR_SCHEDULE') {
                    if (passwordInput === '123456') {
                        performClearSchedule();
                        closeModal();
                    } else {
                        alert('密碼錯誤');
                    }
                } else if (type === 'MEMBER_LOCK') { 
                    if (!passwordInput.trim()) {
                        alert('請設定密碼');
                        return;
                    }
                    markLocalUpdate();
                    setMemberSettings(prev => ({
                        ...prev,
                        [target]: { locked: true, password: passwordInput }
                    }));
                    addLog(`鎖定成員 ${target}`);
                    closeModal();
                } else if (type === 'MEMBER_UNLOCK') { 
                    const setting = memberSettings[target];
                    if (setting && setting.password === passwordInput) {
                        markLocalUpdate();
                        setMemberSettings(prev => ({
                            ...prev,
                            [target]: { ...setting, locked: false } 
                        }));
                        const newSettings = { ...memberSettings };
                        delete newSettings[target]; 
                        setMemberSettings(newSettings);
                        
                        addLog(`解鎖成員 ${target}`);
                        closeModal();
                    } else {
                        alert('成員密碼錯誤');
                    }
                }
            };

            // --- Event Handlers ---
            const handleCellClick = (person, dateStr, e) => {
                e.stopPropagation();
                e.preventDefault();
                if (isLocked) return;
                
                if (memberSettings[person]?.locked) {
                    alert(`成員 ${person} 已鎖定，請先點擊名字旁的鎖頭解鎖。`);
                    return;
                }

                if (activeCell && activeCell.person === person && activeCell.dateStr === dateStr) {
                    setActiveCell(null);
                    return;
                }
                const rect = e.currentTarget.getBoundingClientRect();
                setActiveCell({
                    person,
                    dateStr,
                    top: rect.bottom, 
                    left: rect.left,
                    height: rect.height,
                    width: rect.width
                });
            };

            const setShift = (type) => {
                if (!activeCell) return;
                const key = `${activeCell.person}-${activeCell.dateStr}`;
                markLocalUpdate();
                setSchedule(prev => {
                    const newSchedule = { ...prev };
                    type === '' ? delete newSchedule[key] : newSchedule[key] = type;
                    return newSchedule;
                });
                addLog(`設定 ${activeCell.person} ${activeCell.dateStr} 為 ${type || '上班'}`);
                setActiveCell(null);
            };

            const performClearSchedule = () => {
                markLocalUpdate();
                const newSchedule = { ...schedule };
                daysInMonth.forEach(day => {
                    staffList.forEach(person => delete newSchedule[`${person}-${getDateKey(day)}`]);
                });
                setSchedule(newSchedule);
                addLog(`清空本月班表`);
            };

            const handleClearClick = () => {
                if (isLocked) return;
                openModal('CLEAR_SCHEDULE', '清空班表', '請輸入密碼以確認清空：');
            };

            const handleLockToggle = () => {
                if (isLocked) {
                    openModal('GLOBAL_UNLOCK', '解鎖班表', '請輸入全域管理密碼 (123)：');
                } else {
                    setIsLocked(true);
                }
            };

            const handleSettingsClick = () => {
                openModal('SETTINGS_ACCESS', '人員管理', '請輸入管理密碼以進入人員管理：');
            };

            const handleMemberLockClick = (person) => {
                if (isLocked) return;
                const isMemberLocked = memberSettings[person]?.locked;
                if (isMemberLocked) {
                    openModal('MEMBER_UNLOCK', `解鎖成員：${person}`, `請輸入 ${person} 的專屬密碼以解鎖：`, person);
                } else {
                    openModal('MEMBER_LOCK', `鎖定成員：${person}`, `請設定 ${person} 的鎖定密碼：`, person);
                }
            };

            // --- Staff Management ---
            const handleAddStaff = () => {
                const name = newStaffName.trim();
                if (name && !staffList.includes(name)) {
                    markLocalUpdate();
                    setStaffList([...staffList, name]);
                    setNewStaffName('');
                    addLog(`新增成員 ${name}`);
                } else if (staffList.includes(name)) {
                    alert("人員已存在");
                }
            };

            const confirmDelete = (name) => {
                markLocalUpdate();
                setStaffList(staffList.filter(s => s !== name));
                setDeletingStaffId(null);
                addLog(`刪除成員 ${name}`);
            };

            const saveEditStaff = (oldName) => {
                if (!tempStaffName.trim()) return;
                if (staffList.includes(tempStaffName) && tempStaffName !== oldName) {
                    alert("名稱重複");
                    return;
                }
                markLocalUpdate();
                const newList = staffList.map(s => s === oldName ? tempStaffName : s);
                setStaffList(newList);

                const newSchedule = { ...schedule };
                Object.keys(newSchedule).forEach(key => {
                    const [pName, ...rest] = key.split('-');
                    const datePart = rest.join('-');
                    if (pName === oldName) {
                        newSchedule[`${tempStaffName}-${datePart}`] = newSchedule[key];
                        delete newSchedule[key];
                    }
                });
                setSchedule(newSchedule);
                
                if (memberSettings[oldName]) {
                    const newSettings = { ...memberSettings };
                    newSettings[tempStaffName] = newSettings[oldName];
                    delete newSettings[oldName];
                    setMemberSettings(newSettings);
                }

                setEditingStaffId(null);
                addLog(`更名成員 ${oldName} -> ${tempStaffName}`);
            };

            // --- Drag & Drop ---
            const handleDragStart = (e, index) => { setDraggedIndex(index); e.dataTransfer.effectAllowed = "move"; };
            const handleDragOver = (e, index) => { e.preventDefault(); if (draggedIndex === index) return; setDragOverIndex(index); };
            const handleDrop = (e, index) => {
                e.preventDefault();
                if (draggedIndex === null || draggedIndex === index) return;
                markLocalUpdate();
                const newStaffList = [...staffList];
                const draggedItemContent = newStaffList[draggedIndex];
                newStaffList.splice(draggedIndex, 1);
                newStaffList.splice(index, 0, draggedItemContent);
                setStaffList(newStaffList);
                setDraggedIndex(null);
                setDragOverIndex(null);
            };
            const handleDragEnd = () => { setDraggedIndex(null); setDragOverIndex(null); };

            // --- Global Click Listener ---
            useEffect(() => {
                const handleClickOutside = () => setActiveCell(null);
                window.addEventListener('click', handleClickOutside);
                const tableEl = tableContainerRef.current;
                if (tableEl) tableEl.addEventListener('scroll', handleClickOutside);
                return () => {
                    window.removeEventListener('click', handleClickOutside);
                    if (tableEl) tableEl.removeEventListener('scroll', handleClickOutside);
                };
            }, []);

            if (loading) {
                return (
                    <div className="flex h-screen w-full items-center justify-center bg-gray-50 flex-col gap-4">
                        <div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <p className="text-gray-500 font-medium animate-pulse">正在同步資料庫...</p>
                    </div>
                );
            }
            
            let popoverStyle = {};
            if (activeCell) {
                const MENU_HEIGHT = 280;
                const spaceBelow = window.innerHeight - activeCell.top;
                const showAbove = spaceBelow < MENU_HEIGHT;
                popoverStyle = {
                    left: Math.min(activeCell.left, window.innerWidth - 100),
                    top: showAbove ? activeCell.top - activeCell.height - 10 : activeCell.top + 5,
                };
                if (showAbove) popoverStyle.transform = 'translateY(-100%)';
            }

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-800 flex flex-col">
                    {/* Header */}
                    <header className="bg-white shadow-sm sticky top-0 z-30">
                        <div className="px-4 py-3 mx-auto flex flex-col lg:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-lg shadow-lg">
                                    <Icon name="Calendar" className="text-white" size={24} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-gray-900 leading-tight">鏡電視政治組排班表</h1>
                                    <div className="flex items-center gap-2 text-xs text-gray-500 mt-1">
                                        {isOfflineMode ? (
                                            <span className="flex items-center gap-1 text-orange-600 font-medium bg-orange-50 px-2 py-0.5 rounded-full border border-orange-200">
                                                <Icon name="CloudOff" size={12} /> ⚠️ 離線模式 (資料儲存於本機)
                                            </span>
                                        ) : (
                                            saveStatus === 'saving' ? (
                                                <span className="flex items-center gap-1 text-orange-500 font-medium">
                                                    <div className="w-2 h-2 bg-orange-500 rounded-full animate-ping"></div>
                                                    <Icon name="CloudUpload" size={12} /> 儲存中...
                                                </span>
                                            ) : (
                                                <span className="flex items-center gap-1 text-green-600 font-medium">
                                                    <Icon name="CloudCheck" size={14} /> 已儲存
                                                </span>
                                            )
                                        )}
                                        {lastUpdatedAt && (
                                            <span className="text-gray-400 border-l pl-2">
                                                {new Date(lastUpdatedAt).toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'})} 更新
                                            </span>
                                        )}
                                    </div>
                                </div>
                                
                                <button 
                                    onClick={handleLockToggle}
                                    className={`ml-2 flex items-center gap-1 px-3 py-1.5 rounded-full text-sm font-medium transition-all ${
                                        isLocked 
                                        ? 'bg-red-50 text-red-600 border border-red-200 hover:bg-red-100' 
                                        : 'bg-green-50 text-green-700 border border-green-200 hover:bg-green-100'
                                    }`}
                                >
                                    <Icon name={isLocked ? "Lock" : "Unlock"} size={14} />
                                    {isLocked ? "已鎖定" : "編輯中"}
                                </button>

                                <button 
                                    onClick={handleSettingsClick}
                                    className={`p-1.5 rounded-full transition-all border ${isLocked ? 'text-gray-300 border-transparent cursor-not-allowed' : 'text-gray-400 hover:text-blue-600 hover:bg-blue-50 border-transparent hover:border-blue-100'}`}
                                    title="設定人員 (需密碼)"
                                >
                                    <Icon name="Settings" size={18} />
                                </button>

                                <button 
                                    onClick={() => setIsHistoryOpen(true)}
                                    className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-all border border-transparent hover:border-blue-100"
                                    title="編輯紀錄"
                                >
                                    <Icon name="History" size={18} />
                                </button>
                            </div>

                            <div className="flex items-center bg-gray-100 rounded-lg p-1 shadow-inner">
                                <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-white rounded-md shadow-sm text-gray-600">
                                    <Icon name="ChevronLeft" size={20} />
                                </button>
                                <span className="px-4 py-1 font-mono text-lg font-semibold min-w-[140px] text-center">
                                    {currentDate.getFullYear()} 年 {currentDate.getMonth() + 1} 月
                                </span>
                                <button onClick={() => changeMonth(1)} className="p-2 hover:bg-white rounded-md shadow-sm text-gray-600">
                                    <Icon name="ChevronRight" size={20} />
                                </button>
                            </div>

                            <div className="flex flex-wrap items-center gap-2 justify-center lg:justify-end">
                                <div className={`flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg border border-gray-200 ${isLocked ? 'opacity-60 grayscale' : ''}`}>
                                    <span className="text-sm text-gray-600 font-medium">本月應休:</span>
                                    <input 
                                        type="number" 
                                        min="0"
                                        max="15"
                                        disabled={isLocked}
                                        value={globalLeaveTarget}
                                        onChange={(e) => {
                                            markLocalUpdate();
                                            setGlobalLeaveTarget(e.target.value);
                                        }}
                                        className="w-12 text-center text-sm font-bold bg-white border border-gray-300 rounded focus:border-blue-500 focus:outline-none disabled:bg-gray-100"
                                    />
                                    <span className="text-sm text-gray-600">天</span>
                                </div>

                                <button 
                                    onClick={handleClearClick} 
                                    disabled={isLocked}
                                    className={`flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg border transition-colors ${
                                        isLocked 
                                        ? 'text-gray-400 bg-gray-100 border-gray-200 cursor-not-allowed' 
                                        : 'text-red-600 bg-red-50 hover:bg-red-100 border-red-200'
                                    }`}
                                >
                                    <Icon name="Trash2" size={16} /> 
                                    <span className="hidden sm:inline">清空</span>
                                </button>

                                {/* 存檔按鈕 */}
                                <button 
                                    onClick={handleDownloadImage}
                                    disabled={screenshotLoading}
                                    className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-slate-800 hover:bg-slate-700 rounded-lg shadow-md disabled:opacity-50"
                                >
                                    {screenshotLoading ? (
                                        <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                    ) : (
                                        <Icon name="Download" size={16} />
                                    )}
                                    <span className="hidden sm:inline">存檔</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Table */}
                    <main className="flex-1 overflow-hidden p-2 md:p-4 flex flex-col">
                        <div ref={tableContainerRef} className="flex-1 overflow-auto bg-white rounded-xl shadow border border-gray-200 relative">
                            <table ref={tableRef} className="w-full border-collapse bg-white">
                                <thead className="sticky top-0 z-20 bg-gray-50 text-xs md:text-sm shadow-sm">
                                    <tr>
                                        {/* 加寬人員欄位到 200px */}
                                        <th className="sticky left-0 z-20 bg-gray-100 p-2 border-b border-r border-gray-200 min-w-[200px] text-left font-bold text-gray-600 h-14 align-bottom">
                                            人員
                                        </th>
                                        {daysInMonth.map(date => {
                                            const isWeek = isWeekend(date);
                                            return (
                                                <th key={getDateKey(date)} className={`p-1 min-w-[48px] text-center border-b border-gray-200 ${isWeek ? 'bg-red-50 text-red-600' : ''}`}>
                                                    <div className="font-bold text-lg leading-none">{date.getDate()}</div>
                                                    <div className="text-[10px] opacity-75 mt-1">{getWeekDay(date)}</div>
                                                </th>
                                            );
                                        })}
                                    </tr>
                                    
                                    <tr className="bg-blue-50/50">
                                        <th className="sticky left-0 z-20 bg-blue-50 p-2 border-b border-r border-gray-200 text-left text-xs font-semibold text-blue-700">
                                            <div className="flex items-center gap-2">
                                                <Icon name="Users" size={14} />
                                                目標上班人數
                                            </div>
                                        </th>
                                        {daysInMonth.map(date => {
                                            const req = getManpowerReq(date);
                                            const actual = calculateActualManpower(date);
                                            const isShort = actual < req;
                                            return (
                                                <td key={getDateKey(date)} className="p-1 border-b border-gray-200 text-center relative align-middle">
                                                    <div className={`flex flex-col items-center justify-center gap-0.5 ${isLocked ? 'opacity-60' : ''}`}>
                                                        <button 
                                                            onClick={() => updateManpowerReq(date, req + 1)}
                                                            disabled={isLocked}
                                                            className={`p-0.5 rounded hover:bg-blue-100 text-blue-600 transition-colors ${isLocked ? 'cursor-not-allowed text-gray-400 hover:bg-transparent' : ''}`}
                                                        >
                                                            <Icon name="ChevronUp" size={12} strokeWidth={3} />
                                                        </button>
                                                        <div className="font-bold text-blue-700 leading-none select-none">{req}</div>
                                                        <button 
                                                            onClick={() => updateManpowerReq(date, Math.max(0, req - 1))}
                                                            disabled={isLocked}
                                                            className={`p-0.5 rounded hover:bg-blue-100 text-blue-600 transition-colors ${isLocked ? 'cursor-not-allowed text-gray-400 hover:bg-transparent' : ''}`}
                                                        >
                                                            <Icon name="ChevronDown" size={12} strokeWidth={3} />
                                                        </button>
                                                    </div>
                                                    {isShort && <div className="absolute top-1 right-1 w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></div>}
                                                </td>
                                            );
                                        })}
                                    </tr>
                                </thead>

                                <tbody className="text-sm">
                                    {staffList.map((person) => {
                                        const usedLeave = calculateUsedLeave(person);
                                        const isReached = usedLeave >= globalLeaveTarget;
                                        const isOver = usedLeave > globalLeaveTarget;
                                        const isMemberLocked = memberSettings[person]?.locked;

                                        return (
                                            <tr key={person} className={`hover:bg-gray-50 transition-colors group ${isMemberLocked ? 'bg-gray-50' : ''}`}>
                                                <td className="sticky left-0 z-10 bg-white p-0 border-b border-r border-gray-200 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                                                    <div className="flex h-12 items-center px-3 justify-between">
                                                        <div className="flex items-center gap-2">
                                                            <button 
                                                                onClick={() => handleMemberLockClick(person)}
                                                                className={`p-1 rounded-full transition-colors ${isMemberLocked ? 'text-red-500 bg-red-50 hover:bg-red-100' : 'text-gray-300 hover:text-gray-500 hover:bg-gray-100'}`}
                                                                title={isMemberLocked ? "已鎖定 (點擊解鎖)" : "未鎖定 (點擊設定密碼鎖定)"}
                                                            >
                                                                <Icon name={isMemberLocked ? "Lock" : "Unlock"} size={14} />
                                                            </button>
                                                            {/* 增加 whitespace-nowrap 確保人名不換行 */}
                                                            <span className={`font-medium whitespace-nowrap ${isMemberLocked ? 'text-gray-500' : 'text-gray-800'}`}>{person}</span>
                                                        </div>
                                                        <span className={`text-[10px] px-1.5 py-0.5 rounded-full whitespace-nowrap ${isOver ? 'bg-red-100 text-red-600 font-bold' : isReached ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>
                                                            已休 {usedLeave}
                                                        </span>
                                                    </div>
                                                </td>

                                                {daysInMonth.map(date => {
                                                    const dateStr = getDateKey(date);
                                                    const key = `${person}-${dateStr}`;
                                                    const shiftType = schedule[key] || '';
                                                    const shiftStyle = SHIFT_TYPES[shiftType] || SHIFT_TYPES[''];

                                                    return (
                                                        <td 
                                                            key={dateStr} 
                                                            className={`p-1 border-b border-r border-gray-100 text-center select-none ${isLocked || isMemberLocked ? 'cursor-default opacity-60' : 'cursor-pointer'}`}
                                                            onClick={(e) => handleCellClick(person, dateStr, e)}
                                                        >
                                                            <div className={`
                                                                w-full h-10 flex items-center justify-center rounded font-bold text-sm transition-all
                                                                ${shiftType ? `${shiftStyle.color} ${shiftStyle.border} border shadow-sm` : (isLocked || isMemberLocked ? '' : 'hover:bg-gray-100')}
                                                            `}>
                                                                {shiftType}
                                                            </div>
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        );
                                    })}
                                    
                                    <tr className="bg-slate-50 border-t-2 border-slate-200">
                                        <td className="sticky left-0 z-10 bg-slate-100 p-3 border-r border-gray-300 font-bold text-slate-700 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] text-right pr-4">
                                            實際上班人數
                                        </td>
                                        {daysInMonth.map(date => {
                                            const actual = calculateActualManpower(date);
                                            const req = getManpowerReq(date);
                                            const isShort = actual < req;
                                            return (
                                                <td key={`total-${getDateKey(date)}`} className={`p-1 border-r border-slate-200 text-center font-mono font-bold text-sm ${isShort ? 'bg-red-50 text-red-600' : 'text-slate-600'}`}>
                                                    {actual}
                                                </td>
                                            )
                                        })}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </main>

                    {/* Floating Menu Portal */}
                    {activeCell && (
                        <div 
                            className="fixed z-[9999] bg-white rounded-lg shadow-xl border border-gray-200 p-1 flex flex-col gap-1 w-24 animate-in fade-in zoom-in duration-150"
                            style={popoverStyle}
                            onClick={(e) => e.stopPropagation()} 
                        >
                            <div className="text-xs text-gray-400 px-2 py-1 text-center border-b border-gray-100 mb-1">
                                {activeCell.person}
                            </div>
                            <button onClick={() => setShift('')} className="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded text-left transition-colors">清除 (上班)</button>
                            {Object.keys(SHIFT_TYPES).filter(t => t !== '').map(type => (
                                <button key={type} onClick={() => setShift(type)} className={`px-3 py-2 text-sm font-bold rounded text-center border active:scale-95 ${SHIFT_TYPES[type].color} ${SHIFT_TYPES[type].border}`}>
                                    {type}
                                </button>
                            ))}
                        </div>
                    )}

                    {/* Staff Settings Modal */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center backdrop-blur-sm p-4" onClick={() => setIsSettingsOpen(false)}>
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                    <h2 className="text-lg font-bold flex items-center gap-2">
                                        <Icon name="Settings" size={20} className="text-gray-600" />
                                        人員管理
                                    </h2>
                                    <button onClick={() => setIsSettingsOpen(false)} className="p-2 hover:bg-gray-200 rounded-full transition-colors"><Icon name="X" size={20} /></button>
                                </div>
                                <div className="p-6 overflow-y-auto">
                                    <div className="flex gap-2 mb-6">
                                        <input type="text" placeholder="輸入姓名..." value={newStaffName} onChange={(e) => setNewStaffName(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleAddStaff()} className="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
                                        <button onClick={handleAddStaff} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-medium flex items-center gap-1 transition-colors disabled:opacity-50" disabled={!newStaffName.trim()}><Icon name="Plus" size={16} /> 新增</button>
                                    </div>
                                    <div className="flex justify-between items-center mb-2"><span className="text-sm text-gray-500 font-medium">現有人員 (可拖曳排序)</span></div>
                                    <div className="flex flex-col gap-2">
                                        {staffList.map((person, index) => (
                                            <div key={person} draggable onDragStart={(e) => handleDragStart(e, index)} onDragOver={(e) => handleDragOver(e, index)} onDrop={(e) => handleDrop(e, index)} onDragEnd={handleDragEnd} className={`flex items-center gap-3 p-3 bg-white border rounded-lg shadow-sm transition-all group select-none ${draggedIndex === index ? 'opacity-50 bg-gray-100 border-dashed border-gray-400' : 'border-gray-200 hover:shadow-md'} ${dragOverIndex === index ? 'border-blue-500 ring-2 ring-blue-100 scale-[1.02]' : ''}`}>
                                                <div className="cursor-grab active:cursor-grabbing p-1 text-gray-300 hover:text-gray-500"><Icon name="GripVertical" size={20} /></div>
                                                {editingStaffId === person ? (
                                                    <div className="flex-1 flex gap-2 animate-in fade-in">
                                                        <input autoFocus value={tempStaffName} onChange={(e) => setTempStaffName(e.target.value)} className="flex-1 border rounded px-2 py-1 text-sm outline-blue-500" />
                                                        <button onClick={() => saveEditStaff(person)} className="p-1 bg-green-100 text-green-600 rounded hover:bg-green-200"><Icon name="CheckCircle" size={16} /></button>
                                                    </div>
                                                ) : (
                                                    <span className="flex-1 font-medium text-gray-700">{person}</span>
                                                )}
                                                <div className="flex gap-1">
                                                    {editingStaffId !== person && (
                                                        <>
                                                            <button onClick={() => { setEditingStaffId(person); setTempStaffName(person); setDeletingStaffId(null); }} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors"><Icon name="Edit2" size={16} /></button>
                                                            {deletingStaffId === person ? (
                                                                <div className="flex items-center gap-1 animate-in slide-in-from-right duration-200">
                                                                    <button onClick={() => confirmDelete(person)} className="px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 font-bold">確認</button>
                                                                    <button onClick={() => setDeletingStaffId(null)} className="p-1 text-gray-400 hover:text-gray-600 rounded"><Icon name="X" size={16} /></button>
                                                                </div>
                                                            ) : (
                                                                <button onClick={() => setDeletingStaffId(person)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors"><Icon name="Trash2" size={16} /></button>
                                                            )}
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Generic Password Modal (Used for Clear, Global Unlock, Member Lock/Unlock) */}
                    {modalConfig.isOpen && (
                        <div className="fixed inset-0 z-[70] bg-black/60 flex items-center justify-center backdrop-blur-sm p-4">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
                                <div className="p-6 flex flex-col items-center gap-4">
                                    <div className="bg-blue-50 p-4 rounded-full">
                                        <Icon name={modalConfig.type.includes('LOCK') ? "Lock" : modalConfig.type === 'CLEAR_SCHEDULE' ? "Trash2" : "Key"} size={32} className="text-blue-500" />
                                    </div>
                                    <h3 className="text-lg font-bold text-gray-800">{modalConfig.title}</h3>
                                    <p className="text-sm text-gray-500 text-center">{modalConfig.message}</p>
                                    
                                    <form onSubmit={handleModalConfirm} className="w-full flex gap-2 mt-2">
                                        <input 
                                            type="password" 
                                            autoFocus
                                            placeholder="請輸入密碼"
                                            value={passwordInput}
                                            onChange={(e) => setPasswordInput(e.target.value)}
                                            className="flex-1 border border-gray-300 rounded-lg px-4 py-2 text-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                        />
                                        <button 
                                            type="submit"
                                            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-medium"
                                        >
                                            確認
                                        </button>
                                    </form>
                                    
                                    <button 
                                        onClick={closeModal}
                                        className="text-gray-400 text-xs hover:text-gray-600 underline"
                                    >
                                        取消
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* History Modal */}
                    {isHistoryOpen && (
                        <div className="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center backdrop-blur-sm p-4" onClick={() => setIsHistoryOpen(false)}>
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[80vh]" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                    <h2 className="text-lg font-bold flex items-center gap-2">
                                        <Icon name="History" size={20} className="text-gray-600" />
                                        編輯紀錄 (最近50筆)
                                    </h2>
                                    <button onClick={() => setIsHistoryOpen(false)} className="p-2 hover:bg-gray-200 rounded-full transition-colors"><Icon name="X" size={20} /></button>
                                </div>
                                <div className="p-0 overflow-y-auto">
                                    {editLogs.length === 0 ? (
                                        <div className="p-8 text-center text-gray-400 text-sm">尚無編輯紀錄</div>
                                    ) : (
                                        <ul className="divide-y divide-gray-100">
                                            {editLogs.map((log, i) => (
                                                <li key={i} className="p-3 hover:bg-gray-50 text-sm">
                                                    <div className="flex justify-between text-xs text-gray-400 mb-1">
                                                        <span>{new Date(log.timestamp).toLocaleString('zh-TW')}</span>
                                                    </div>
                                                    <div className="text-gray-700">{log.message}</div>
                                                </li>
                                            ))}
                                        </ul>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>