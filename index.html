<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鏡電視政治組排班表 (同步優化版)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* 自定義捲軸樣式 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .animate-pulse-custom { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-gray-50">

    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // 引入 updateDoc, arrayUnion, arrayRemove, deleteField 以進行細微更新
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, arrayRemove, deleteField, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJ_b9BiX1zT7WFu8f08uoKxeV8vgDUHz4",
            authDomain: "fuktrip.firebaseapp.com",
            projectId: "fuktrip",
            storageBucket: "fuktrip.firebasestorage.app",
            messagingSenderId: "663462561018",
            appId: "1:663462561018:web:d0c9f00c9fed0253a2b543",
            measurementId: "G-KME94X3EKH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose to window
        window.db = db;
        window.auth = auth;
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.arrayUnion = arrayUnion;
        window.arrayRemove = arrayRemove;
        window.deleteField = deleteField;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // --- Constants & Icons ---
        const APP_ID = 'mirror-tv-schedule';
        const DOC_PATH = ['artifacts', APP_ID, 'public', 'data', 'main_data', 'schedule_v1']; // Path array for easy access
        const DEFAULT_STAFF_LIST = ['徐葳倫', '李依庭', '吳洛瑩', '尹智剛', '程郁育', '楊旂'];
        
        const SHIFT_TYPES = {
            '': { label: '', color: 'bg-white', text: '' }, 
            '休': { label: '休', color: 'bg-red-100 text-red-700', border: 'border-red-300' },
            '夜': { label: '夜', color: 'bg-slate-800 text-white', border: 'border-slate-600' },
            '特休': { label: '特休', color: 'bg-green-100 text-green-700', border: 'border-green-300' },
            '補': { label: '補', color: 'bg-orange-100 text-orange-700', border: 'border-orange-300' }
        };

        const ICONS = {
            Calendar: <path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" />,
            Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>,
            Unlock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 9.9-1" /></>,
            Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2zM12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z" />,
            ChevronLeft: <path d="m15 18-6-6 6-6" />,
            ChevronRight: <path d="m9 18 6-6-6-6" />,
            Trash2: <><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></>,
            Users: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></>,
            ChevronUp: <path d="m18 15-6-6-6 6" />,
            ChevronDown: <path d="m6 9 6 6 6-6" />,
            X: <path d="M18 6 6 18M6 6l12 12" />,
            Plus: <path d="M5 12h14M12 5v14" />,
            GripVertical: <><circle cx="9" cy="12" r="1" /><circle cx="9" cy="5" r="1" /><circle cx="9" cy="19" r="1" /><circle cx="15" cy="12" r="1" /><circle cx="15" cy="5" r="1" /><circle cx="15" cy="19" r="1" /></>,
            CheckCircle: <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14M22 4 12 14.01l-3-3" />,
            Edit2: <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />,
            History: <><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /><path d="M12 7v5l4 2" /></>,
            Key: <><path d="m21 2-2 2m-7.6 7.6a6 6 0 1 1-1.4-1.4L11 11l5 5a2 2 0 0 1 2.8 2.8l.9.9m-1.5-1.5-.9-.9" /><circle cx="7.5" cy="7.5" r=".5" fill="currentColor" /></>,
            Download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />,
            CloudCheck: <path d="m9 11 3 3L22 4" />,
            CloudUpload: <><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" /><path d="M12 12v9" /><path d="m16 16-4-4-4 4" /></>
        };

        const Icon = ({ name, size = 16, className = "", strokeWidth = 2 }) => {
            if (!ICONS[name]) return null;
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}>{ICONS[name]}</svg>;
        };

        // --- Utils ---
        // Debounce Hook only for specific text inputs or sliders, NOT for main data saving
        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => setDebouncedValue(value), delay);
                return () => clearTimeout(handler);
            }, [value, delay]);
            return debouncedValue;
        }

        const App = () => {
            // --- Basic State ---
            const getInitialDate = () => {
                const today = new Date();
                return new Date(today.getFullYear(), today.getMonth() + 1, 1);
            };
            const [currentDate, setCurrentDate] = useState(getInitialDate);
            const [daysInMonth, setDaysInMonth] = useState([]);

            // --- Data State ---
            const [staffList, setStaffList] = useState(DEFAULT_STAFF_LIST);
            const [schedule, setSchedule] = useState({});
            const [manpowerReqs, setManpowerReqs] = useState({});
            const [globalLeaveTarget, setGlobalLeaveTarget] = useState(8);
            const [memberSettings, setMemberSettings] = useState({});
            const [editLogs, setEditLogs] = useState([]); 
            
            // --- UI State ---
            const [activeCell, setActiveCell] = useState(null);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isHistoryOpen, setIsHistoryOpen] = useState(false); 
            const [editingStaffId, setEditingStaffId] = useState(null);
            const [deletingStaffId, setDeletingStaffId] = useState(null);
            const [tempStaffName, setTempStaffName] = useState('');
            const [newStaffName, setNewStaffName] = useState('');
            const [isLocked, setIsLocked] = useState(false); 
            const [screenshotLoading, setScreenshotLoading] = useState(false);
            const [saveStatus, setSaveStatus] = useState('saved'); // saved, saving, error
            
            // Modal
            const [modalConfig, setModalConfig] = useState({ isOpen: false, type: '', title: '', message: '', target: null });
            const [passwordInput, setPasswordInput] = useState('');
            
            // Drag & Drop
            const [draggedIndex, setDraggedIndex] = useState(null);
            const [dragOverIndex, setDragOverIndex] = useState(null);

            // System
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [lastUpdatedAt, setLastUpdatedAt] = useState(null);
            const tableContainerRef = useRef(null);
            const tableRef = useRef(null);
            
            // Use refs to hold latest state for optimistic updates to prevent flickering if snapshot is slow
            const scheduleRef = useRef({});
            const staffListRef = useRef([]);

            // --- Helpers for Dates ---
            useEffect(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const date = new Date(year, month, 1);
                const days = [];
                while (date.getMonth() === month) {
                    days.push(new Date(date));
                    date.setDate(date.getDate() + 1);
                }
                setDaysInMonth(days);
            }, [currentDate]);

            const changeMonth = (offset) => {
                setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1));
                setActiveCell(null);
            };

            const getDateKey = (date) => date.toISOString().split('T')[0];
            const getWeekDay = (date) => ['日', '一', '二', '三', '四', '五', '六'][date.getDay()];
            const isWeekend = (date) => date.getDay() === 0 || date.getDay() === 6;

            // --- Firebase Logic: Initialization ---
            useEffect(() => {
                if (!window.auth) return;
                window.signInAnonymously(window.auth).catch(console.error);
                return window.onAuthStateChanged(window.auth, (u) => setUser(u));
            }, []);

            // --- Firebase Logic: Snapshot Listener ---
            useEffect(() => {
                if (!user || !window.db) return;
                const docRef = window.doc(window.db, ...DOC_PATH);
                
                const unsubscribe = window.onSnapshot(docRef, { includeMetadataChanges: true }, (docSnap) => {
                    if (docSnap.exists()) {
                        // ignore pending writes to avoid UI flicker on local changes
                        if (docSnap.metadata.hasPendingWrites) return;

                        const data = docSnap.data();
                        
                        // Handle Staff List
                        if (data.staffList) {
                            setStaffList(data.staffList);
                            staffListRef.current = data.staffList;
                        }

                        // Handle Schedule (Backward Compatibility for JSON)
                        let newSchedule = {};
                        if (data.schedule) {
                            // Prefer native Map
                            newSchedule = data.schedule;
                        } else if (data.scheduleJson) {
                            // Fallback to old JSON format
                            try { newSchedule = JSON.parse(data.scheduleJson); } catch (e) {}
                        }
                        setSchedule(newSchedule);
                        scheduleRef.current = newSchedule;

                        // Handle Manpower Reqs
                        let newManpower = {};
                        if (data.manpowerReqs) {
                            newManpower = data.manpowerReqs;
                        } else if (data.manpowerReqsJson) {
                            try { newManpower = JSON.parse(data.manpowerReqsJson); } catch (e) {}
                        }
                        setManpowerReqs(newManpower);

                        if (data.globalLeaveTarget) setGlobalLeaveTarget(data.globalLeaveTarget);
                        if (data.memberSettings) setMemberSettings(data.memberSettings);
                        if (data.editLogs) setEditLogs(data.editLogs);
                        if (data.updatedAt) setLastUpdatedAt(data.updatedAt);
                        
                    } else {
                        // Init Doc
                        window.setDoc(docRef, {
                            staffList: DEFAULT_STAFF_LIST,
                            schedule: {}, // Initialize as Map, not string
                            manpowerReqs: {},
                            globalLeaveTarget: 8,
                            memberSettings: {},
                            editLogs: [],
                            updatedAt: Date.now()
                        });
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user]);

            // --- DATA SAVING (ATOMIC OPERATIONS) ---
            // This is the core fix: update ONLY what changed
            
            const logAction = async (message) => {
                // Add log to local state immediately for UI
                const newLog = { timestamp: Date.now(), message };
                setEditLogs(prev => [newLog, ...prev].slice(0, 50));
                
                // Fire and forget log update
                try {
                    const docRef = window.doc(window.db, ...DOC_PATH);
                    // We only store last 50 logs in DB to save space, but here we just prepend one
                    // For simplicity in this no-backend setup, we update the whole log array
                    // A better way would be a subcollection, but keeping it simple:
                    await window.updateDoc(docRef, {
                        editLogs: [newLog, ...editLogs].slice(0, 49)
                    });
                } catch(e) { console.error("Log error", e); }
            };

            const updateShiftInDb = async (person, dateStr, type) => {
                if (!user) return;
                setSaveStatus('saving');
                const key = `${person}-${dateStr}`;
                const docRef = window.doc(window.db, ...DOC_PATH);
                
                try {
                    // Critical: Update ONLY this specific field using dot notation
                    // If type is empty, we delete the field to keep DB clean
                    if (type === '') {
                        await window.updateDoc(docRef, {
                            [`schedule.${key}`]: window.deleteField(),
                            updatedAt: Date.now(),
                            updatedBy: user.uid
                        });
                    } else {
                        await window.updateDoc(docRef, {
                            [`schedule.${key}`]: type,
                            updatedAt: Date.now(),
                            updatedBy: user.uid
                        });
                    }
                    setSaveStatus('saved');
                    setLastUpdatedAt(Date.now());
                } catch (error) {
                    console.error("Shift save error", error);
                    setSaveStatus('error');
                    alert("儲存失敗，請檢查網路連線");
                }
            };

            const setShift = (type) => {
                if (!activeCell) return;
                const { person, dateStr } = activeCell;
                const key = `${person}-${dateStr}`;
                
                // Optimistic Update
                setSchedule(prev => {
                    const next = { ...prev };
                    if (type === '') delete next[key];
                    else next[key] = type;
                    return next;
                });
                
                logAction(`設定 ${person} ${dateStr} 為 ${type || '上班'}`);
                setActiveCell(null);
                
                // Trigger Atomic Save
                updateShiftInDb(person, dateStr, type);
            };

            const updateManpowerReqInDb = async (dateStr, value) => {
                if(!user) return;
                setSaveStatus('saving');
                const docRef = window.doc(window.db, ...DOC_PATH);
                try {
                    await window.updateDoc(docRef, {
                        [`manpowerReqs.${dateStr}`]: value,
                        updatedAt: Date.now()
                    });
                    setSaveStatus('saved');
                } catch(e) { console.error(e); setSaveStatus('error'); }
            };

            // Use debounce only for the DB write of manpower, but update UI immediately
            const debouncedManpowerUpdate = useCallback(
                _.debounce((dateStr, value) => updateManpowerReqInDb(dateStr, value), 1000), 
                [user]
            );

            // Simple lodash-like debounce implementation since we don't have lodash
            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            }
            // Re-create debounce inside component to access state if needed, or outside
            // Using a ref to hold the debounced function
            const debouncedManpowerRef = useRef(debounce((d, v) => updateManpowerReqInDb(d, v), 800)).current;

            const updateManpowerReq = (date, value) => {
                if (isLocked) return;
                const val = parseInt(value) || 0;
                const dateStr = getDateKey(date);
                
                setManpowerReqs(prev => ({ ...prev, [dateStr]: val }));
                // Trigger debounced save
                debouncedManpowerRef(dateStr, val);
            };

            // --- Atomic Staff Management ---
            const handleAddStaff = async () => {
                const name = newStaffName.trim();
                if (!name) return;
                if (staffList.includes(name)) { alert("人員已存在"); return; }
                
                // Optimistic
                setStaffList(prev => [...prev, name]);
                setNewStaffName('');
                logAction(`新增成員 ${name}`);
                setSaveStatus('saving');

                try {
                    const docRef = window.doc(window.db, ...DOC_PATH);
                    await window.updateDoc(docRef, {
                        staffList: window.arrayUnion(name),
                        updatedAt: Date.now()
                    });
                    setSaveStatus('saved');
                } catch(e) { console.error(e); setSaveStatus('error'); }
            };

            const confirmDelete = async (name) => {
                // Optimistic
                setStaffList(prev => prev.filter(s => s !== name));
                setDeletingStaffId(null);
                logAction(`刪除成員 ${name}`);
                setSaveStatus('saving');

                try {
                    const docRef = window.doc(window.db, ...DOC_PATH);
                    await window.updateDoc(docRef, {
                        staffList: window.arrayRemove(name),
                        updatedAt: Date.now()
                    });
                    setSaveStatus('saved');
                } catch(e) { console.error(e); setSaveStatus('error'); }
            };

            const saveEditStaff = async (oldName) => {
                if (!tempStaffName.trim()) return;
                if (staffList.includes(tempStaffName) && tempStaffName !== oldName) {
                    alert("名稱重複"); return;
                }
                
                setSaveStatus('saving');
                const docRef = window.doc(window.db, ...DOC_PATH);

                // This is a complex op (rename), harder to do atomically in one go without transaction
                // But we can do it safely enough:
                try {
                    // 1. Update Staff List
                    const newList = staffList.map(s => s === oldName ? tempStaffName : s);
                    setStaffList(newList);
                    
                    // 2. Migrate Schedule Keys locally
                    const newSchedule = { ...schedule };
                    const updates = {}; // For batch update
                    
                    // Prepare Firestore updates
                    updates['staffList'] = newList;
                    
                    // Migrate shifts
                    Object.keys(newSchedule).forEach(key => {
                        const [pName, ...rest] = key.split('-');
                        if (pName === oldName) {
                            const datePart = rest.join('-');
                            const val = newSchedule[key];
                            // Local
                            newSchedule[`${tempStaffName}-${datePart}`] = val;
                            delete newSchedule[key];
                            // Firestore: delete old field, add new field
                            updates[`schedule.${oldName}-${datePart}`] = window.deleteField();
                            updates[`schedule.${tempStaffName}-${datePart}`] = val;
                        }
                    });
                    setSchedule(newSchedule);

                    // Migrate Settings
                    if (memberSettings[oldName]) {
                        const s = memberSettings[oldName];
                        updates[`memberSettings.${oldName}`] = window.deleteField();
                        updates[`memberSettings.${tempStaffName}`] = s;
                        
                        const newSet = { ...memberSettings };
                        newSet[tempStaffName] = s;
                        delete newSet[oldName];
                        setMemberSettings(newSet);
                    }
                    
                    updates['updatedAt'] = Date.now();
                    
                    await window.updateDoc(docRef, updates);
                    
                    setEditingStaffId(null);
                    logAction(`更名成員 ${oldName} -> ${tempStaffName}`);
                    setSaveStatus('saved');
                } catch (e) { console.error(e); setSaveStatus('error'); }
            };

            const handleDrop = async (e, index) => {
                e.preventDefault();
                if (draggedIndex === null || draggedIndex === index) return;
                
                const newStaffList = [...staffList];
                const draggedItemContent = newStaffList[draggedIndex];
                newStaffList.splice(draggedIndex, 1);
                newStaffList.splice(index, 0, draggedItemContent);
                
                setStaffList(newStaffList);
                setDraggedIndex(null);
                setDragOverIndex(null);

                // Save full list order
                setSaveStatus('saving');
                try {
                    const docRef = window.doc(window.db, ...DOC_PATH);
                    await window.updateDoc(docRef, {
                        staffList: newStaffList,
                        updatedAt: Date.now()
                    });
                    setSaveStatus('saved');
                } catch(e) { console.error(e); setSaveStatus('error'); }
            };

            // --- Member Locking (Atomic) ---
            const toggleMemberLock = async (person, lockConfig) => {
                setSaveStatus('saving');
                try {
                    const docRef = window.doc(window.db, ...DOC_PATH);
                    if (lockConfig === null) {
                        // Unlock
                        await window.updateDoc(docRef, {
                            [`memberSettings.${person}`]: window.deleteField()
                        });
                        const ns = {...memberSettings}; delete ns[person];
                        setMemberSettings(ns);
                        logAction(`解鎖成員 ${person}`);
                    } else {
                        // Lock
                        await window.updateDoc(docRef, {
                            [`memberSettings.${person}`]: lockConfig
                        });
                        setMemberSettings(prev => ({...prev, [person]: lockConfig}));
                        logAction(`鎖定成員 ${person}`);
                    }
                    setSaveStatus('saved');
                } catch(e) { console.error(e); setSaveStatus('error'); }
            };
            
            // --- Global Settings (Atomic) ---
            const saveGlobalLeaveTarget = async (val) => {
                setGlobalLeaveTarget(val);
                try {
                    const docRef = window.doc(window.db, ...DOC_PATH);
                    await window.updateDoc(docRef, { globalLeaveTarget: val });
                } catch(e){}
            };

            const performClearSchedule = async () => {
                setSaveStatus('saving');
                try {
                    // Clear all schedule fields
                    // Since we can't iterate keys in backend easily without a function, 
                    // we just replace the whole schedule map with empty object.
                    // THIS IS THE ONLY PLACE we overwrite schedule, but it's intentional "Clear All"
                    const docRef = window.doc(window.db, ...DOC_PATH);
                    await window.updateDoc(docRef, {
                        schedule: {},
                        updatedAt: Date.now()
                    });
                    setSchedule({});
                    logAction(`清空本月班表`);
                    setSaveStatus('saved');
                } catch(e) { console.error(e); setSaveStatus('error'); }
            };

            // --- Other Handlers (mostly same as before, updated to call new functions) ---
            
            const handleDownloadImage = async () => {
                if (!tableRef.current) return;
                setScreenshotLoading(true);
                try {
                    const originalOverflow = tableContainerRef.current.style.overflow;
                    tableContainerRef.current.style.overflow = 'visible';
                    const canvas = await html2canvas(tableRef.current, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    tableContainerRef.current.style.overflow = originalOverflow;
                    const link = document.createElement('a');
                    link.download = `鏡電視班表_${currentDate.getFullYear()}_${currentDate.getMonth() + 1}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (err) { alert("存檔失敗"); } finally { setScreenshotLoading(false); }
            };

            const openModal = (type, title, message, target = null) => {
                setModalConfig({ isOpen: true, type, title, message, target });
                setPasswordInput('');
            };
            const closeModal = () => {
                setModalConfig({ ...modalConfig, isOpen: false });
                setPasswordInput('');
            };

            const handleModalConfirm = (e) => {
                e.preventDefault();
                const { type, target } = modalConfig;

                if (type === 'GLOBAL_UNLOCK') {
                    if (passwordInput === '123') { setIsLocked(false); closeModal(); }
                    else alert('密碼錯誤');
                } else if (type === 'SETTINGS_ACCESS') {
                    if (passwordInput === '123456') { closeModal(); setIsSettingsOpen(true); }
                    else alert('密碼錯誤');
                } else if (type === 'CLEAR_SCHEDULE') {
                    if (passwordInput === '123456') { performClearSchedule(); closeModal(); }
                    else alert('密碼錯誤');
                } else if (type === 'MEMBER_LOCK') { 
                    if (!passwordInput.trim()) { alert('請設定密碼'); return; }
                    toggleMemberLock(target, { locked: true, password: passwordInput });
                    closeModal();
                } else if (type === 'MEMBER_UNLOCK') { 
                    const setting = memberSettings[target];
                    if (setting && setting.password === passwordInput) {
                        toggleMemberLock(target, null); // Unlock
                        closeModal();
                    } else { alert('成員密碼錯誤'); }
                }
            };

            const handleCellClick = (person, dateStr, e) => {
                e.stopPropagation(); e.preventDefault();
                if (isLocked) return;
                if (memberSettings[person]?.locked) { alert(`成員 ${person} 已鎖定`); return; }
                if (activeCell && activeCell.person === person && activeCell.dateStr === dateStr) { setActiveCell(null); return; }
                const rect = e.currentTarget.getBoundingClientRect();
                setActiveCell({ person, dateStr, top: rect.bottom, left: rect.left, height: rect.height, width: rect.width });
            };

            const handleClearClick = () => { if (!isLocked) openModal('CLEAR_SCHEDULE', '清空班表', '請輸入密碼以確認清空：'); };
            const handleLockToggle = () => { isLocked ? openModal('GLOBAL_UNLOCK', '解鎖班表', '請輸入全域管理密碼 (123)：') : setIsLocked(true); };
            const handleSettingsClick = () => { openModal('SETTINGS_ACCESS', '人員管理', '請輸入管理密碼：'); };
            const handleMemberLockClick = (person) => {
                if (isLocked) return;
                memberSettings[person]?.locked ? 
                    openModal('MEMBER_UNLOCK', `解鎖成員：${person}`, `請輸入 ${person} 的密碼：`, person) :
                    openModal('MEMBER_LOCK', `鎖定成員：${person}`, `請設定 ${person} 的密碼：`, person);
            };
            const handleDragStart = (e, index) => { setDraggedIndex(index); e.dataTransfer.effectAllowed = "move"; };
            const handleDragOver = (e, index) => { e.preventDefault(); if (draggedIndex === index) return; setDragOverIndex(index); };
            const handleDragEnd = () => { setDraggedIndex(null); setDragOverIndex(null); };

            // Logic for Calculations
            const getManpowerReq = (date) => {
                const key = getDateKey(date);
                return manpowerReqs[key] !== undefined ? manpowerReqs[key] : (isWeekend(date) ? 3 : 4);
            };
            const calculateActualManpower = (date) => {
                const dateStr = getDateKey(date);
                let workingCount = 0;
                staffList.forEach(person => {
                    const shift = schedule[`${person}-${dateStr}`];
                    const isOff = ['休', '特休', '補'].includes(shift);
                    if (!isOff) workingCount++;
                });
                return workingCount;
            };
            const calculateUsedLeave = (person) => {
                let count = 0;
                daysInMonth.forEach(day => {
                    if(['休', '特休', '補'].includes(schedule[`${person}-${getDateKey(day)}`])) count++;
                });
                return count;
            };

            // Global Click to Close Menu
            useEffect(() => {
                const handleClickOutside = () => setActiveCell(null);
                window.addEventListener('click', handleClickOutside);
                const tableEl = tableContainerRef.current;
                if (tableEl) tableEl.addEventListener('scroll', handleClickOutside);
                return () => {
                    window.removeEventListener('click', handleClickOutside);
                    if (tableEl) tableEl.removeEventListener('scroll', handleClickOutside);
                };
            }, []);

            if (loading) {
                return (
                    <div className="flex h-screen w-full items-center justify-center bg-gray-50 flex-col gap-4">
                        <div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <p className="text-gray-500 font-medium animate-pulse">正在同步雲端資料庫...</p>
                    </div>
                );
            }

            // Popover positioning
            let popoverStyle = {};
            if (activeCell) {
                const MENU_HEIGHT = 280;
                const spaceBelow = window.innerHeight - activeCell.top;
                const showAbove = spaceBelow < MENU_HEIGHT;
                popoverStyle = {
                    left: Math.min(activeCell.left, window.innerWidth - 100),
                    top: showAbove ? activeCell.top - activeCell.height - 10 : activeCell.top + 5,
                };
                if (showAbove) popoverStyle.transform = 'translateY(-100%)';
            }

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-800 flex flex-col">
                    <header className="bg-white shadow-sm sticky top-0 z-30">
                        <div className="px-4 py-3 mx-auto flex flex-col lg:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-lg shadow-lg">
                                    <Icon name="Calendar" className="text-white" size={24} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-gray-900 leading-tight">鏡電視政治組排班表</h1>
                                    <div className="flex items-center gap-2 text-xs text-gray-500 mt-1">
                                        {saveStatus === 'saving' ? (
                                            <span className="flex items-center gap-1 text-orange-500 font-medium">
                                                <div className="w-2 h-2 bg-orange-500 rounded-full animate-ping"></div>儲存中...
                                            </span>
                                        ) : saveStatus === 'error' ? (
                                             <span className="flex items-center gap-1 text-red-500 font-medium">儲存失敗</span>
                                        ) : (
                                            <span className="flex items-center gap-1 text-green-600 font-medium"><Icon name="CloudCheck" size={14} /> 已同步</span>
                                        )}
                                        {lastUpdatedAt && <span className="text-gray-400 border-l pl-2">{new Date(lastUpdatedAt).toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'})}</span>}
                                    </div>
                                </div>
                                
                                <button onClick={handleLockToggle} className={`ml-2 flex items-center gap-1 px-3 py-1.5 rounded-full text-sm font-medium transition-all ${isLocked ? 'bg-red-50 text-red-600 border border-red-200 hover:bg-red-100' : 'bg-green-50 text-green-700 border border-green-200 hover:bg-green-100'}`}>
                                    <Icon name={isLocked ? "Lock" : "Unlock"} size={14} /> {isLocked ? "已鎖定" : "編輯中"}
                                </button>
                                <button onClick={handleSettingsClick} className={`p-1.5 rounded-full transition-all border ${isLocked ? 'text-gray-300 border-transparent cursor-not-allowed' : 'text-gray-400 hover:text-blue-600 hover:bg-blue-50 border-transparent hover:border-blue-100'}`} title="設定"><Icon name="Settings" size={18} /></button>
                                <button onClick={() => setIsHistoryOpen(true)} className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-all border border-transparent hover:border-blue-100" title="紀錄"><Icon name="History" size={18} /></button>
                            </div>

                            <div className="flex items-center bg-gray-100 rounded-lg p-1 shadow-inner">
                                <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-white rounded-md shadow-sm text-gray-600"><Icon name="ChevronLeft" size={20} /></button>
                                <span className="px-4 py-1 font-mono text-lg font-semibold min-w-[140px] text-center">{currentDate.getFullYear()} 年 {currentDate.getMonth() + 1} 月</span>
                                <button onClick={() => changeMonth(1)} className="p-2 hover:bg-white rounded-md shadow-sm text-gray-600"><Icon name="ChevronRight" size={20} /></button>
                            </div>

                            <div className="flex flex-wrap items-center gap-2 justify-center lg:justify-end">
                                <div className={`flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg border border-gray-200 ${isLocked ? 'opacity-60 grayscale' : ''}`}>
                                    <span className="text-sm text-gray-600 font-medium">本月應休:</span>
                                    <input type="number" min="0" max="15" disabled={isLocked} value={globalLeaveTarget} 
                                        onChange={(e) => saveGlobalLeaveTarget(e.target.value)}
                                        className="w-12 text-center text-sm font-bold bg-white border border-gray-300 rounded focus:border-blue-500 focus:outline-none disabled:bg-gray-100"
                                    />
                                    <span className="text-sm text-gray-600">天</span>
                                </div>
                                <button onClick={handleClearClick} disabled={isLocked} className={`flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg border transition-colors ${isLocked ? 'text-gray-400 bg-gray-100 border-gray-200 cursor-not-allowed' : 'text-red-600 bg-red-50 hover:bg-red-100 border-red-200'}`}>
                                    <Icon name="Trash2" size={16} /> <span className="hidden sm:inline">清空</span>
                                </button>
                                <button onClick={handleDownloadImage} disabled={screenshotLoading} className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-slate-800 hover:bg-slate-700 rounded-lg shadow-md disabled:opacity-50">
                                    {screenshotLoading ? <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <Icon name="Download" size={16} />}
                                    <span className="hidden sm:inline">存檔</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="flex-1 overflow-hidden p-2 md:p-4 flex flex-col">
                        <div ref={tableContainerRef} className="flex-1 overflow-auto bg-white rounded-xl shadow border border-gray-200 relative">
                            <table ref={tableRef} className="w-full border-collapse bg-white">
                                <thead className="sticky top-0 z-20 bg-gray-50 text-xs md:text-sm shadow-sm">
                                    <tr>
                                        <th className="sticky left-0 z-20 bg-gray-100 p-2 border-b border-r border-gray-200 min-w-[120px] md:min-w-[200px] text-left font-bold text-gray-600 h-14 align-bottom">人員</th>
                                        {daysInMonth.map(date => {
                                            const isWeek = isWeekend(date);
                                            return (
                                                <th key={getDateKey(date)} className={`p-1 min-w-[40px] md:min-w-[48px] text-center border-b border-gray-200 ${isWeek ? 'bg-red-50 text-red-600' : ''}`}>
                                                    <div className="font-bold text-lg leading-none">{date.getDate()}</div>
                                                    <div className="text-[10px] opacity-75 mt-1">{getWeekDay(date)}</div>
                                                </th>
                                            );
                                        })}
                                    </tr>
                                    <tr className="bg-blue-50/50">
                                        <th className="sticky left-0 z-20 bg-blue-50 p-2 border-b border-r border-gray-200 text-left text-xs font-semibold text-blue-700">
                                            <div className="flex items-center gap-2"><Icon name="Users" size={14} />目標上班人數</div>
                                        </th>
                                        {daysInMonth.map(date => {
                                            const req = getManpowerReq(date);
                                            const actual = calculateActualManpower(date);
                                            const isShort = actual < req;
                                            return (
                                                <td key={getDateKey(date)} className="p-1 border-b border-gray-200 text-center relative align-middle">
                                                    <div className={`flex flex-col items-center justify-center gap-0.5 ${isLocked ? 'opacity-60' : ''}`}>
                                                        <button onClick={() => updateManpowerReq(date, req + 1)} disabled={isLocked} className={`p-0.5 rounded hover:bg-blue-100 text-blue-600 transition-colors ${isLocked ? 'cursor-not-allowed text-gray-400 hover:bg-transparent' : ''}`}><Icon name="ChevronUp" size={12} strokeWidth={3} /></button>
                                                        <div className="font-bold text-blue-700 leading-none select-none">{req}</div>
                                                        <button onClick={() => updateManpowerReq(date, Math.max(0, req - 1